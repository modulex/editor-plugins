<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>joycss/lib/locating/vertical.js - editor-plugins</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="editor-plugins"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: editor-plugins 1.1.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/BackColor.html">BackColor</a></li>
            
                <li><a href="../classes/Bold.html">Bold</a></li>
            
                <li><a href="../classes/Button.html">Button</a></li>
            
                <li><a href="../classes/CheckBoxSourceArea.html">CheckBoxSourceArea</a></li>
            
                <li><a href="../classes/Code.html">Code</a></li>
            
                <li><a href="../classes/Draft.html">Draft</a></li>
            
                <li><a href="../classes/DragUpload.html">DragUpload</a></li>
            
                <li><a href="../classes/ElementPath.html">ElementPath</a></li>
            
                <li><a href="../classes/Flash.html">Flash</a></li>
            
                <li><a href="../classes/FontColor.html">FontColor</a></li>
            
                <li><a href="../classes/FontFamily.html">FontFamily</a></li>
            
                <li><a href="../classes/FontSize.html">FontSize</a></li>
            
                <li><a href="../classes/Heading.html">Heading</a></li>
            
                <li><a href="../classes/Image.html">Image</a></li>
            
                <li><a href="../classes/Indent.html">Indent</a></li>
            
                <li><a href="../classes/Italic.html">Italic</a></li>
            
                <li><a href="../classes/JustifyCenter.html">JustifyCenter</a></li>
            
                <li><a href="../classes/JustifyLeft.html">JustifyLeft</a></li>
            
                <li><a href="../classes/JustifyRight.html">JustifyRight</a></li>
            
                <li><a href="../classes/Link.html">Link</a></li>
            
                <li><a href="../classes/Maximize.html">Maximize</a></li>
            
                <li><a href="../classes/MultipleUpload.html">MultipleUpload</a></li>
            
                <li><a href="../classes/OrderedList.html">OrderedList</a></li>
            
                <li><a href="../classes/Outdent.html">Outdent</a></li>
            
                <li><a href="../classes/PageBreak.html">PageBreak</a></li>
            
                <li><a href="../classes/parserlib.css.PropertyValuePart.html">parserlib.css.PropertyValuePart</a></li>
            
                <li><a href="../classes/Preview.html">Preview</a></li>
            
                <li><a href="../classes/RemoveFormat.html">RemoveFormat</a></li>
            
                <li><a href="../classes/Resize.html">Resize</a></li>
            
                <li><a href="../classes/Separator.html">Separator</a></li>
            
                <li><a href="../classes/Smiley.html">Smiley</a></li>
            
                <li><a href="../classes/SourceArea.html">SourceArea</a></li>
            
                <li><a href="../classes/StrikeThrough.html">StrikeThrough</a></li>
            
                <li><a href="../classes/Table.html">Table</a></li>
            
                <li><a href="../classes/Underline.html">Underline</a></li>
            
                <li><a href="../classes/Undo.html">Undo</a></li>
            
                <li><a href="../classes/UnorderedList.html">UnorderedList</a></li>
            
                <li><a href="../classes/Video.html">Video</a></li>
            
                <li><a href="../classes/XiaMiMusic.html">XiaMiMusic</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/back-color.html">back-color</a></li>
            
                <li><a href="../modules/bold.html">bold</a></li>
            
                <li><a href="../modules/button.html">button</a></li>
            
                <li><a href="../modules/checkbox-source-area.html">checkbox-source-area</a></li>
            
                <li><a href="../modules/code.html">code</a></li>
            
                <li><a href="../modules/draft.html">draft</a></li>
            
                <li><a href="../modules/drag-upload.html">drag-upload</a></li>
            
                <li><a href="../modules/eindent.html">eindent</a></li>
            
                <li><a href="../modules/element-path.html">element-path</a></li>
            
                <li><a href="../modules/flash.html">flash</a></li>
            
                <li><a href="../modules/font-color.html">font-color</a></li>
            
                <li><a href="../modules/font-family.html">font-family</a></li>
            
                <li><a href="../modules/font-size.html">font-size</a></li>
            
                <li><a href="../modules/heading.html">heading</a></li>
            
                <li><a href="../modules/image.html">image</a></li>
            
                <li><a href="../modules/italic.html">italic</a></li>
            
                <li><a href="../modules/justify-center.html">justify-center</a></li>
            
                <li><a href="../modules/justify-left.html">justify-left</a></li>
            
                <li><a href="../modules/justify-right.html">justify-right</a></li>
            
                <li><a href="../modules/link.html">link</a></li>
            
                <li><a href="../modules/maximize.html">maximize</a></li>
            
                <li><a href="../modules/multiple-upload.html">multiple-upload</a></li>
            
                <li><a href="../modules/ordered-list.html">ordered-list</a></li>
            
                <li><a href="../modules/outdent.html">outdent</a></li>
            
                <li><a href="../modules/page-break.html">page-break</a></li>
            
                <li><a href="../modules/preview.html">preview</a></li>
            
                <li><a href="../modules/remove-format.html">remove-format</a></li>
            
                <li><a href="../modules/resize.html">resize</a></li>
            
                <li><a href="../modules/separator.html">separator</a></li>
            
                <li><a href="../modules/smiley.html">smiley</a></li>
            
                <li><a href="../modules/source-area.html">source-area</a></li>
            
                <li><a href="../modules/strike-through.html">strike-through</a></li>
            
                <li><a href="../modules/table.html">table</a></li>
            
                <li><a href="../modules/underline.html">underline</a></li>
            
                <li><a href="../modules/undo.html">undo</a></li>
            
                <li><a href="../modules/unordered-list.html">unordered-list</a></li>
            
                <li><a href="../modules/video.html">video</a></li>
            
                <li><a href="../modules/xiami-music.html">xiami-music</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: joycss/lib/locating/vertical.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x27;use strict&#x27;;
var forEach = require(&#x27;../common/utils&#x27;).forEach;
var GrowingPacker = require(&#x27;./packer&#x27;);
/**
 * 垂直布局算法，计算图片位置spritepos_left和spritepos_top，大图的宽度高度
 * @param {object} images 图片对象，记录align, height, width, repeat
 * @param {object} spriteConfig 图片对应的css规则
 */
function Vertical(spriteConfig, layout){
  this.spriteConfig = spriteConfig;
  this.layout = layout;
  this.width = 0;
  this.height = 0;
  this.labels = {
    //固定定位
    fix: [],
    //占独立一行
    line: [],
    //紧凑拼图
    close: [],
    //放置在最后
    end: []
  };
  this.blocks = [];
  this.init();
}

Vertical.prototype = {
  constructor: Vertical,
  init: function(){
    var spriteConfig = this.spriteConfig;
    var labels = this.labels;

    //console.log(JSON.stringify(spriteConfig));
    spriteConfig.forEach(this.setLables, this);

    this.sortImgs(labels.line);
    this.sortImgs(labels.close);

    forEach(labels.close, this.setBlocks, this);

    if (!this.pack()){
      labels.line = labels.close.concat(labels.line);
      labels.close = [];
      this.sortImgs(labels.line);
    }

    forEach(labels.fix, this.siteImg, this);
    forEach(labels.close, this.closeSiteImg, this);
    forEach(labels.line, this.siteImg, this);
    forEach(labels.end, this.siteImg, this);
  },

  // packer算法调用
  // 检测packer算法是否成功，如果中间某个fit为null，说明失败
  // 失败的情况，去掉失败的块，重新运算
  pack: function(){
    // 如果三个不到，退出pack运算
    if (this.blocks.length &lt; 3) return false;
    var packer = new GrowingPacker();
    packer.fit(this.blocks);
    var labels = this.labels;
    var isOk = true;

    this.blocks.forEach(function(block, i){
      if (!block.fit){
        // 删除出现错误的块
        this.blocks.splice(i, 1);
        var item = labels.close.splice(i, 1);
        labels.line.push(item[0]);
        isOk = false;
      }
    }, this);

    if (!isOk) return this.pack();
    this.width = packer.root.w;
    this.height = packer.root.h;
    return true;
  },

  setBlocks: function(imageInfo){
    var box = imageInfo.box;
    var blocks = this.blocks;
    var params = box.background.params;
    //设置默认右边距
    var width = imageInfo.width + imageInfo[&#x27;spritepos_left&#x27;];
    width += params.right ? parseInt(params.right, 10) : 10;

    var height = imageInfo.height + imageInfo[&#x27;spritepos_top&#x27;];
    height += params.bottom ? parseInt(params.bottom, 10) : 10;

    width = box.width &gt; width ? box.width : width;
    height = box.height &gt; height ? box.height : height;

    blocks.push({w: width, h: height});
  },

  closeSiteImg: function(imageInfo, i){
    var fit = this.blocks[i].fit;
    imageInfo.coods = [fit.x, fit.y];
    this.siteImg(imageInfo);
  },

  setLables: function(imageInfo){
    var labels = this.labels;
    //var def = this.spriteConfig[img];
    var box = imageInfo.box;
    var params = box.background.params;
    if (&#x27;base&#x27; in params){
      labels.fix.push(imageInfo);
    } else if (&#x27;end&#x27; in params) {
      labels.end.push(imageInfo);
    } else if (this.layout === &#x27;auto&#x27; &amp;&amp;
        box.hasWidth &amp;&amp;
        imageInfo.repeat === &#x27;no-repeat&#x27; &amp;&amp;
        !imageInfo[&#x27;align&#x27;] &amp;&amp;
        box.width &lt; (imageInfo.width + imageInfo.spritepos_left)* 3){//盒子宽度小于图片的3倍
      labels.close.push(imageInfo);
    } else {

      if (this.layout === &#x27;close&#x27; &amp;&amp; !imageInfo[&#x27;align&#x27;] &amp;&amp; 
        imageInfo[&#x27;repeat&#x27;] === &#x27;no-repeat&#x27; &amp;&amp; 
        box.width &lt; (imageInfo.width + imageInfo.spritepos_left)* 3 &amp;&amp;
        !(&#x27;line&#x27; in params)){

        labels.close.push(imageInfo);
      } else {
        labels.line.push(imageInfo);
      }
    }
  },

  siteImg: function(imageInfo){
    var width = this.width;
    var height = this.height;
    var box = imageInfo.box;
    var params = box.background.params;

    var imageWidth = imageInfo.width + imageInfo[&#x27;spritepos_left&#x27;];
    if (imageWidth&gt; width) width = imageWidth;

    //设置固定的坐标
    var coods = imageInfo.coods || params.coods || &#x27;&#x27;;
    var left, top;

    if (!coods) {
      //position计算
      left = imageInfo[&#x27;align&#x27;] || &#x27;0&#x27;;
      top = height;
      //if (top &amp;&amp; imageInfo.height &lt; height){
      if (top){
        top = &#x27;-&#x27; + top + &#x27;px&#x27;;
      } else {
        top = 0;
      }

      //repeat时候必须是整数倍宽度
      if (imageInfo[&#x27;repeat&#x27;] === &#x27;repeat-x&#x27;){
        var ceil = Math.ceil(width / imageInfo.width);
        if (ceil &lt; 2) ceil = 2;
        width = imageInfo[&#x27;width&#x27;] * ceil;
      }

      var bottom = box.height - imageInfo[&#x27;spritepos_top&#x27;] - imageInfo[&#x27;height&#x27;];
      height += parseInt(imageInfo[&#x27;spritepos_top&#x27;]);
      imageInfo[&#x27;spritepos_top&#x27;] = height;

      height += parseInt(imageInfo.height, 10);
      //bottom padding
      if (params.bottom){
        height += parseInt(params.bottom, 10);
      } else if (box.hasHeight) {
        height += bottom &gt; 0 ? bottom : 0;
      } else {
        //默认10像素间距
        height += 10;
      }
    } else {
      coods = coods instanceof Array ? coods : JSON.parse(coods);

      top = Math.abs(coods[1]);
      imageInfo[&#x27;spritepos_top&#x27;] =  top + imageInfo[&#x27;spritepos_top&#x27;];
      top = top ? &#x27;-&#x27; + top + &#x27;px&#x27; : top;

      left = Math.abs(coods[0]);
      imageInfo[&#x27;spritepos_left&#x27;] = left + imageInfo[&#x27;spritepos_left&#x27;];
      left = left ? &#x27;-&#x27; + left + &#x27;px&#x27;: left;
    }

    imageInfo.position = left + &#x27; &#x27; + top;
    this.width = width;
    this.height = height;
  },

  sortImgs: function(images){
    images.sort(function(imageInfo1, imageInfo2){
      var params1 = imageInfo1.box.background.params;
      var params2 = imageInfo2.box.background.params;

      //base参数，强制放在前面
      if (&#x27;base&#x27; in params1){
        return -1;
      } else if(&#x27;base&#x27; in params2) {
        return 1;
      } else {
        return imageInfo2.width - imageInfo1.width;
      }
    });
  }
};

module.exports = Vertical;

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
