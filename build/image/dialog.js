define("kg/editor-plugins/1.2.0/image/dialog",["util","editor","io","../dialog","tabs","../menubutton","./dialog-tpl","ua","node"],function(e,i,t){function a(e){for(var i=e;i;){var t=i.nodeName();if("a"===t)return i;if(f.$block[t]||f.$blockLimit[t])return null;i=i.parent()}return null}function r(e,i){var t=this;t.editor=e,t.imageCfg=i||{},t.cfg=t.imageCfg.upload||null,t.suffix=t.cfg&&t.cfg.suffix||"png,jpg,jpeg,gif",t.suffixReg=new RegExp(t.suffix.split(/,/).join("|")+"$","i"),t.suffixWarning="只允许后缀名为"+t.suffix+"的图片"}var n=e("util"),l=e("editor"),o=e("io"),g=e("../dialog"),s=e("tabs"),d=e("../menubutton"),m=e("./dialog-tpl"),f=l.XHTML_DTD,c=e("ua"),u=e("node"),p="http://",h="自动",v=10,k='<div style="padding:5px 20px 20px;"><a href="javascript:void(\'确定\')" class="{prefixCls}img-insert {prefixCls}button ks-inline-block" style="margin-right:30px;">确定</a> <a  href="javascript:void(\'取消\')" class="{prefixCls}img-cancel {prefixCls}button ks-inline-block">取消</a></div>',b="请点击浏览上传图片",x=l.Utils.valInput;r.prototype={_prepare:function(){function e(e){return e.files?e.files[0].size:0}var i=this,t=i.editor,a=t.get("prefixCls")+"editor-";i.dialog=i.d=new g({width:500,headerContent:"图片",bodyContent:n.substitute(m,{prefixCls:a}),footerContent:n.substitute(k,{prefixCls:a}),mask:!0}).render();var r=i.d.get("el"),f=r.one("."+a+"img-cancel"),v=r.one("."+a+"img-insert"),C=l.Utils.verifyInputs,L=r.one("."+a+"img-setting");i.uploadForm=r.one("."+a+"img-upload-form"),i.imgLocalUrl=r.one("."+a+"img-local-url"),i.tab=new s({srcNode:i.d.get("body").one("."+a+"img-tabs"),prefixCls:a+"img-"}).render(),i.imgLocalUrl.val(b),i.imgUrl=r.one("."+a+"img-url"),i.imgHeight=r.one("."+a+"img-height"),i.imgBorderWidth=r.one("."+a+"img-border-width"),i.imgWidth=r.one("."+a+"img-width"),i.imgRatio=r.one("."+a+"img-ratio"),i.imgAlign=d.Select.decorate(r.one("."+a+"img-align"),{prefixCls:a+"big-",width:80,menuCfg:{prefixCls:a+"",render:r}}),i.imgMargin=r.one("."+a+"img-margin"),i.imgLink=r.one("."+a+"img-link"),i.imgLinkBlank=r.one("."+a+"img-link-blank");var I=l.Utils.placeholder;I(i.imgUrl,p),I(i.imgHeight,h),I(i.imgWidth,h),I(i.imgLink,"http://"),i.imgHeight.on("keyup",function(){var e=parseInt(x(i.imgHeight),10);e&&i.imgRatio[0].checked&&!i.imgRatio[0].disabled&&i.imgRatioValue&&x(i.imgWidth,Math.floor(e*i.imgRatioValue))}),i.imgWidth.on("keyup",function(){var e=parseInt(x(i.imgWidth),10);e&&i.imgRatio[0].checked&&!i.imgRatio[0].disabled&&i.imgRatioValue&&x(i.imgHeight,Math.floor(e/i.imgRatioValue))}),f.on("click",function(e){i.d.hide(),e.halt()});var _=u('<a class="'+a+'button ks-inline-block" style="position:absolute;z-index:'+l.baseZIndex(l.ZIndexManager.LOADING_CANCEL)+';left:-9999px;top:-9999px;">取消上传</a>').appendTo(document.body,void 0);if(i.loadingCancel=_,v.on("click",function(t){if(t.halt(),i.imageCfg.remote!==!1&&1!==n.indexOf(i.tab.getSelectedTab(),i.tab.getTabs())||!i.cfg){if(!C(r.all("input")))return;i._insert()}else{if(!C(L.all("input")))return;if(i.imgLocalUrl.val()===b)return void alert("请先选择文件!");if(!i.suffixReg.test(i.imgLocalUrl.val()))return alert(i.suffixWarning),i.uploadForm[0].reset(),void i.imgLocalUrl.val(b);var a=e(i.fileInput[0]);if(U&&a/1e3>U)return void alert("上传图片最大："+U/1e3+"M");i.d.loading(),_.on("click",function(e){e.halt(),s.abort()});var g=l.Utils.normParams(i.cfg.serverParams)||{};g["document-domain"]=document.domain;var s=o({data:g,url:i.cfg.serverUrl,form:i.uploadForm[0],dataType:"json",type:"post",complete:function(e,t){if(_.css({left:-9999,top:-9999}),i.d.unloading(),"abort"!==t){if(e||(e={error:"服务器出错，请重试"}),e.error)return void alert(e.error);x(i.imgUrl,e.imgUrl),(new Image).src=e.imgUrl,i._insert()}}}),d=i.d.get("el"),m=d.offset(),f=d[0].offsetWidth,c=d[0].offsetHeight;_.css({left:m.left+f/2.5,top:m.top+c/1.5})}}),i.cfg){i.cfg.extraHTML&&r.one("."+a+"img-up-extraHTML").html(i.cfg.extraHTML);var y=r.one("."+a+"image-up"),U=i.cfg&&i.cfg.sizeLimit;i.fileInput=u('<input type="file" style="position:absolute;cursor:pointer;left:'+(c.ie?"360":c.chrome?"319":"369")+'px;z-index:2;top:0px;height:26px;" size="1" name="'+(i.cfg.fileInput||"Filedata")+'"/>').insertAfter(i.imgLocalUrl),U&&(b="单张图片容量不超过 "+U/1e3+" M"),i.imgLocalUrl.val(b),i.fileInput.css("opacity",0),i.fileInput.on("mouseenter",function(){y.addClass(""+a+"button-hover")}),i.fileInput.on("mouseleave",function(){y.removeClass(""+a+"button-hover")}),i.fileInput.on("change",function(){var e=i.fileInput.val();i.imgLocalUrl.val(e.replace(/.+[\/\\]/,""))}),i.imageCfg.remote===!1&&i.tab.removeItemAt(0,1)}else i.tab.removeItemAt(1,1);i._prepare=n.noop},_insert:function(){var e,i=this,t=x(i.imgUrl),r=parseInt(x(i.imgHeight),10),l=parseInt(x(i.imgWidth),10),o=i.imgAlign.get("value"),g=parseInt(x(i.imgBorderWidth),10),s=parseInt(i.imgMargin.val(),10),d="";r&&(d+="height:"+r+"px;"),l&&(d+="width:"+l+"px;"),"none"!==o&&(d+="float:"+o+";"),isNaN(s)||0===s||(d+="margin:"+s+"px;"),g&&(d+="border:"+g+"px solid"),i.d.hide(),i.selectedEl?(e=i.selectedEl,i.editor.execCommand("save"),i.selectedEl.attr({src:t,_ke_saved_src:t,style:d})):(e=u("<img "+(d?'style="'+d+'"':"")+' src="'+t+'" _ke_saved_src="'+t+'" alt="" />',i.editor.get("document")[0]),i.editor.insertElement(e)),setTimeout(function(){var t,r,l,o,g=a(e),s=n.trim(x(i.imgLink)),d=i.editor.getSelection(),m=i.imgLinkBlank.attr("checked")?"_blank":"_self",f=0;if(g&&(t=g.attr("target")||"_self",s!==g.attr("href")||t!==m?(e._4eBreakParent(g),(r=e.prev())&&"a"===r.nodeName()&&!r[0].childNodes.length&&r.remove(),(l=e.next())&&"a"===l.nodeName()&&!l[0].childNodes.length&&l.remove()):f=1),!f&&s){i.selectedEl||(o=d.createBookmarks()),g=u("<a>"),g.attr("_ke_saved_href",s).attr("href",s).attr("target",m);var c=e[0];c.parentNode.replaceChild(g[0],c),g.append(c)}o?d.selectBookmarks(o):i.selectedEl&&i.editor.getSelection().selectElement(i.selectedEl),f||i.editor.execCommand("save")},100)},_update:function(e){var i,t=this,r=0,n=l.Utils.resetInput;if(t.selectedEl=e,e&&t.imageCfg.remote!==!1){x(t.imgUrl,e.attr("src"));var o=parseInt(e.style("width"),10),g=parseInt(e.style("height"),10),s=parseInt(e.style("border-width"),10)||0;t.imgBorderWidth.val(s),g?x(t.imgHeight,g):n(t.imgHeight),o?x(t.imgWidth,o):n(t.imgWidth),t.imgAlign.set("value",e.style("float")||"none");var d=parseInt(e.style("margin"),10)||0;t.imgMargin.val(d),t.imgRatio[0].disabled=!1,t.imgRatioValue=o/g,i=a(e)}else{var m=t.editor,f=m.getSelection(),c=f&&f.getCommonAncestor();c&&(i=a(c));var u=t.imageCfg.defaultMargin;void 0===u&&(u=v),2===t.tab.get("bar").get("children").length&&(r=1),t.imgLinkBlank.attr("checked",!0),n(t.imgUrl),n(t.imgLink),n(t.imgHeight),n(t.imgWidth),t.imgBorderWidth.val(0),t.imgAlign.set("value","none"),t.imgMargin.val(u),t.imgRatio[0].disabled=!0,t.imgRatioValue=null}i?(x(t.imgLink,i.attr("_ke_saved_href")||i.attr("href")),t.imgLinkBlank.attr("checked","_blank"===i.attr("target"))):(n(t.imgLink),t.imgLinkBlank.attr("checked",!0)),t.uploadForm[0].reset(),t.imgLocalUrl.val(b);var p=t.tab;p.setSelectedTab(p.getTabAt(r))},show:function(e){var i=this;i._prepare(),i._update(e),i.d.show()},destroy:function(){var e=this;e.d.destroy(),e.tab.destroy(),e.loadingCancel&&e.loadingCancel.remove(),e.imgAlign&&e.imgAlign.destroy()}},t.exports=r});