define("kg/editor-plugins/1.2.0/bubble",["util","ua","overlay","editor"],function(e,t,i){function o(e,t,i){return i>=e&&t>=i}function r(e,t){var i=e.get("y"),r=i+e.get("el").outerHeight(),l=t.get("y"),n=l+t.get("el").outerHeight();return o(i,r,n)||o(i,r,l)}function l(e){var t=null,i=e.get("editor"),o=i.getControls();return d.each(o,function(i){i.isKeBubble&&i!==e&&i.get("visible")&&r(e,i)&&(t?t.get("y")<i.get("y")&&(t=i):t=i)}),t}function n(e){var t=e.get("editorSelectedEl");if(!t)return void 0;var i=e.get("editor"),o=i.get("window"),r=i.get("iframe").offset(),l=r.top,n=r.left,d=n+o.width(),f=l+o.height(),a=t.offset();a=s.Utils.getXY(a,i);var g,v,c=a.top,b=a.left,h=b+t.width(),p=c+t.height();return u.ie&&"img"===t[0].nodeName.toLowerCase()&&p>f?void 0:(p>f&&f>c?v=f-30:p>l&&f>p&&(v=p),h>n&&n>b?g=n:b>n&&d>b&&(g=b),void 0!==g&&void 0!==v?[g,v]:void 0)}var d=e("util"),u=e("ua"),f=e("overlay"),s=e("editor"),a={zIndex:s.baseZIndex(s.ZIndexManager.BUBBLE_VIEW),elCls:"{prefixCls}editor-bubble",prefixCls:"{prefixCls}editor-",effect:{effect:"fade",duration:.3}};s.prototype.addBubble=function(e,t,i){function o(){g.hide();var e=v.get("window");e&&(e.detach("scroll",u),b.stop())}function r(){var e=n(g);if(e){g.move(e[0],e[1]);var t=l(g);t&&(e[1]=t.get("y")+t.get("el").outerHeight(),g.move(e[0],e[1])),g.get("visible")||g.show()}}function u(){g.get("editorSelectedEl")&&(g.hide(),b())}function s(){var e=v.get("window");e.on("scroll",u),r()}var g,v=this,c=v.get("prefixCls");i=i||{},i.editor=v,d.mix(i,a),i.elCls=d.substitute(i.elCls,{prefixCls:c}),i.prefixCls=d.substitute(i.prefixCls,{prefixCls:c}),g=new f(i),g.isKeBubble=1,v.addControl(e+"/bubble",g),v.on("selectionChange",function(e){var i,r,l=e.path,n=l.elements;if(l&&n){if(r=l.lastElement,!r)return;i=t(r),i?(g.set("editorSelectedEl",i),g.hide(),d.later(s,10)):o()}}),v.on("sourceMode",o);var b=d.buffer(r,350)}});