<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>joycss/lib/csslib/spriteDef.js - editor-plugins</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="editor-plugins"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: editor-plugins 1.1.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/BackColor.html">BackColor</a></li>
            
                <li><a href="../classes/Bold.html">Bold</a></li>
            
                <li><a href="../classes/Button.html">Button</a></li>
            
                <li><a href="../classes/CheckBoxSourceArea.html">CheckBoxSourceArea</a></li>
            
                <li><a href="../classes/Code.html">Code</a></li>
            
                <li><a href="../classes/Draft.html">Draft</a></li>
            
                <li><a href="../classes/DragUpload.html">DragUpload</a></li>
            
                <li><a href="../classes/ElementPath.html">ElementPath</a></li>
            
                <li><a href="../classes/Flash.html">Flash</a></li>
            
                <li><a href="../classes/FontColor.html">FontColor</a></li>
            
                <li><a href="../classes/FontFamily.html">FontFamily</a></li>
            
                <li><a href="../classes/FontSize.html">FontSize</a></li>
            
                <li><a href="../classes/Heading.html">Heading</a></li>
            
                <li><a href="../classes/Image.html">Image</a></li>
            
                <li><a href="../classes/Indent.html">Indent</a></li>
            
                <li><a href="../classes/Italic.html">Italic</a></li>
            
                <li><a href="../classes/JustifyCenter.html">JustifyCenter</a></li>
            
                <li><a href="../classes/JustifyLeft.html">JustifyLeft</a></li>
            
                <li><a href="../classes/JustifyRight.html">JustifyRight</a></li>
            
                <li><a href="../classes/Link.html">Link</a></li>
            
                <li><a href="../classes/Maximize.html">Maximize</a></li>
            
                <li><a href="../classes/MultipleUpload.html">MultipleUpload</a></li>
            
                <li><a href="../classes/OrderedList.html">OrderedList</a></li>
            
                <li><a href="../classes/Outdent.html">Outdent</a></li>
            
                <li><a href="../classes/PageBreak.html">PageBreak</a></li>
            
                <li><a href="../classes/parserlib.css.PropertyValuePart.html">parserlib.css.PropertyValuePart</a></li>
            
                <li><a href="../classes/Preview.html">Preview</a></li>
            
                <li><a href="../classes/RemoveFormat.html">RemoveFormat</a></li>
            
                <li><a href="../classes/Resize.html">Resize</a></li>
            
                <li><a href="../classes/Separator.html">Separator</a></li>
            
                <li><a href="../classes/Smiley.html">Smiley</a></li>
            
                <li><a href="../classes/SourceArea.html">SourceArea</a></li>
            
                <li><a href="../classes/StrikeThrough.html">StrikeThrough</a></li>
            
                <li><a href="../classes/Table.html">Table</a></li>
            
                <li><a href="../classes/Underline.html">Underline</a></li>
            
                <li><a href="../classes/Undo.html">Undo</a></li>
            
                <li><a href="../classes/UnorderedList.html">UnorderedList</a></li>
            
                <li><a href="../classes/Video.html">Video</a></li>
            
                <li><a href="../classes/XiaMiMusic.html">XiaMiMusic</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/back-color.html">back-color</a></li>
            
                <li><a href="../modules/bold.html">bold</a></li>
            
                <li><a href="../modules/button.html">button</a></li>
            
                <li><a href="../modules/checkbox-source-area.html">checkbox-source-area</a></li>
            
                <li><a href="../modules/code.html">code</a></li>
            
                <li><a href="../modules/draft.html">draft</a></li>
            
                <li><a href="../modules/drag-upload.html">drag-upload</a></li>
            
                <li><a href="../modules/eindent.html">eindent</a></li>
            
                <li><a href="../modules/element-path.html">element-path</a></li>
            
                <li><a href="../modules/flash.html">flash</a></li>
            
                <li><a href="../modules/font-color.html">font-color</a></li>
            
                <li><a href="../modules/font-family.html">font-family</a></li>
            
                <li><a href="../modules/font-size.html">font-size</a></li>
            
                <li><a href="../modules/heading.html">heading</a></li>
            
                <li><a href="../modules/image.html">image</a></li>
            
                <li><a href="../modules/italic.html">italic</a></li>
            
                <li><a href="../modules/justify-center.html">justify-center</a></li>
            
                <li><a href="../modules/justify-left.html">justify-left</a></li>
            
                <li><a href="../modules/justify-right.html">justify-right</a></li>
            
                <li><a href="../modules/link.html">link</a></li>
            
                <li><a href="../modules/maximize.html">maximize</a></li>
            
                <li><a href="../modules/multiple-upload.html">multiple-upload</a></li>
            
                <li><a href="../modules/ordered-list.html">ordered-list</a></li>
            
                <li><a href="../modules/outdent.html">outdent</a></li>
            
                <li><a href="../modules/page-break.html">page-break</a></li>
            
                <li><a href="../modules/preview.html">preview</a></li>
            
                <li><a href="../modules/remove-format.html">remove-format</a></li>
            
                <li><a href="../modules/resize.html">resize</a></li>
            
                <li><a href="../modules/separator.html">separator</a></li>
            
                <li><a href="../modules/smiley.html">smiley</a></li>
            
                <li><a href="../modules/source-area.html">source-area</a></li>
            
                <li><a href="../modules/strike-through.html">strike-through</a></li>
            
                <li><a href="../modules/table.html">table</a></li>
            
                <li><a href="../modules/underline.html">underline</a></li>
            
                <li><a href="../modules/undo.html">undo</a></li>
            
                <li><a href="../modules/unordered-list.html">unordered-list</a></li>
            
                <li><a href="../modules/video.html">video</a></li>
            
                <li><a href="../modules/xiami-music.html">xiami-music</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: joycss/lib/csslib/spriteDef.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&quot;use strict&quot;;
var path      = require(&#x27;path&#x27;);
var StdClass  = require(&#x27;../common/stdclass&#x27;);
var Config    = require(&#x27;../common/config&#x27;);
var Log = require(&#x27;../common/log&#x27;);

var graph     = Config.joyrc(&#x27;php&#x27;) ? &#x27;php&#x27;: &#x27;node-gd&#x27;;
var Api       = require(&#x27;../graph/&#x27; + graph);
var some      = require(&#x27;../common/utils&#x27;).some;
var forEach   = require(&#x27;../common/utils&#x27;).forEach;
var mixin     = require(&#x27;../common/utils&#x27;).mixin;
var util      = require(&#x27;util&#x27;);
var Box       = require(&#x27;./value/box&#x27;);
var url       = require(&#x27;url&#x27;);

var PARAMS    = {
  &#x27;nosprite&#x27;   : &#x27;esc&#x27;,
  &#x27;direction&#x27;  : &#x27;way&#x27;,
  &#x27;horizontal&#x27; : &#x27;h&#x27;,
  &#x27;force8bit&#x27;  : &#x27;png24&#x27; 
};

var conf = {
  &quot;background&quot; : &quot;ffffff7f&quot;,
  &quot;colorcount&quot; : &quot;256&quot;,
  &quot;dataurl&quot;    : false,
  &quot;filename&quot;   : &quot;&quot;,
  &quot;width&quot;      : 0,
  &quot;height&quot;     : 0,
  &quot;force8bit&quot;  : true,
  &quot;imagetype&quot;  : 3,
  &quot;layout&quot;     : &quot;vertical&quot;,
  //默认间距
  &quot;margin&quot;     : 0
};

var imageUrlReg = /url\([&#x27;&quot;]*([a-z0-9A-Z&amp;?=_\-.,\[\]\/\\]+)[&#x27;&quot;]*\)/;
//console.log(imageUrlReg.exec(&#x27;background: red;&#x27;));
//console.log(imageUrlReg.exec(&#x27;background: url(&quot;b\\a.png?cood=[0,-230]&quot;) top left;&#x27;));

function SpriteDef (){
  StdClass.apply(this, arguments);
}

StdClass.extend(SpriteDef, StdClass, {

  attributes: {
    //目标文件
    file         : &#x27;&#x27;,
    basename     : &#x27;&#x27;,
    id           : 0,
    ids          : {},
    imgPath      : &#x27;&#x27;,
    //预处理数组，处理id顺序关系
    preParam     : [],
    ruleIds      : [],
    //配置方式
    config       : {},
    layout       : &#x27;auto&#x27;,
    force8bit    : true,
    background   : &#x27;ffffff7f&#x27;,
    cssReader    : {},
    changedRules : {},
    extraRules   : [],
    cssImgs      : [],
    spritesImgs  : [],
    output: {}
  },

  CONSIT: {
  },

  _init: function(){
    var file = this.get(&#x27;file&#x27;);
    if (!file) throw Error(&#x27;file is not defined&#x27;);

    var basename = path.basename(file, &#x27;.css&#x27;);
    this.set(&#x27;basename&#x27;, basename);
    conf.force8bit = this.get(&#x27;force8bit&#x27;);
    conf.background = this.get(&#x27;background&#x27;);
    /**
     * 所有sprites属性集合
     */
    this.sprites = {};

    /**
     * 所有含有background的css集合，{id: url}，id指css集合id，url是图片路径
     */
    this.images = {};

    /**
     * 图片属性集合，记录图片大小以及图片类型
     */
    this.imagesDef = {};
    this.cssResult = &#x27;&#x27;;

    this.imagesMap = {};

    this._bind();
  },

  /**
   * 初始化配置，对应可能存在的多图情况
   */
  initSpriteConf: function(params){
    var id = this.get(&#x27;id&#x27;);
    var basename = this.get(&#x27;basename&#x27;);
    var ids = this.get(&#x27;ids&#x27;);
    var spriteId = id ? basename + id : basename;
    var imgPath = this.get(&#x27;imgPath&#x27;);

    this.sprites[spriteId] = mixin(conf, {});
    this.sprites[spriteId][&#x27;images&#x27;] = {};
    var config = this.get(&#x27;config&#x27;);
    //合并全局配置
    mixin(config[&#x27;global&#x27;], this.sprites[spriteId]);
    if (imgPath) {
      var imgDest = imgPath + &#x27;/&#x27; + spriteId + &#x27;-sprite.png&#x27;;
      this.sprites[spriteId][&#x27;filename&#x27;] = imgDest;
      var imgCss = imgDest;
      if (this.get(&#x27;relative&#x27;)) {
        imgCss = this.get(&#x27;relative&#x27;) + &#x27;/&#x27; + spriteId + &#x27;-sprite.png&#x27;;
        this.sprites[spriteId][&#x27;relative&#x27;] = imgCss;
      }

      var output = this.get(&#x27;output&#x27;);
      output[imgCss] = path.join(path.dirname(this.get(&#x27;file&#x27;)), imgDest);
    }

    var dir = params[PARAMS[&#x27;direction&#x27;]];
    if (dir &amp;&amp; dir == PARAMS[&#x27;horizontal&#x27;]) {
      this.sprites[spriteId][&#x27;layout&#x27;] = &#x27;horizontal&#x27;;
    }

    if (config[id]) mixin(config[id], this.sprites[spriteId]);

    ids[id] = spriteId;
    id++;
    this.set(&#x27;id&#x27;, id);
    return spriteId;
  },

  _bind: function(){
    var cssReader = this.get(&#x27;cssReader&#x27;);
    //收集css规则
    cssReader.on(&#x27;ruleEnd&#x27;, this._getRule, this);
    //收集规则结束
    cssReader.on(&#x27;change:timeEnd&#x27;, this._cssEnd, this);
    this.on(&#x27;change:imgPath&#x27;, this._setImgPath);
  },

  /**
   * 设置sprites图片的url地址，规则是imgPath + id + &#x27;-sprite&#x27;.png，id由两部分构
   * 成，前缀为css文件名，后缀是id，默认情况下id为空，其他id从1开始计数，imgPath
   * 是由第一个需要做拼图的图片地址决定的
   */
  _setImgPath: function(e){
    var path = e.now + &#x27;/&#x27;;
    forEach(this.sprites, function(sprite, id){
      if (!sprite.filename) sprite[&#x27;filename&#x27;] = path + id + &#x27;-sprite.png&#x27;;
    });
  },

  /**
   * 获取css属性组合
   * @param e {object} 一组css规则{selector: [], property: [], value: [], id: 0}
   * selector, property, value分别是css规则的选择器、属性和值，id是规则序号
   */
  _getRule: function(e){
    var property = e.property;
    var ruleIds = this.get(&#x27;ruleIds&#x27;);
    var imageIndex = property.indexOf(&#x27;background&#x27;);

    if (imageIndex == -1) imageIndex = property.indexOf(&#x27;background-image&#x27;);

    ruleIds.push(e.id);
    if (imageIndex &gt; -1) {
      this._collectImages(e, imageIndex);
    }
  },


  /**
   * 获取css中背景图
   * @param css {object} css规则
   * @param imageIndex {number} 背景图属性所在的位置
   */
  _collectImages: function(css, imageIndex){
    var urlVal = css.value[imageIndex];
    var image  = this._isSpriteImage(urlVal, imageIndex, css);
    var images = this.images;

    if (image){
      image = path.relative(&#x27;./&#x27;, image);
      image = image.replace(/\\+/g, &#x27;/&#x27;);
      images[css.id] = image;
    }
  },

  /**
   * 判断是否是需要做sprite的图片，默认情况下，所有的图片都需要做拼合处理，当遇
   * 到如下情况是，不做拼图：
   * 1. 如果是http方式url，不做sprite
   * 2. 图片url参数中有ESC_KEY，比如a.png?esc
   * @param val {string} css background 对应的value值，比如 url(a.png) left
   * right;
   */
  _isSpriteImage: function(val, index, rule){
    //存在url，并且url不是http方式
    var isHttpUrl = val.indexOf(&#x27;//&#x27;) &gt; -1;
    var ret = false;
    if (!isHttpUrl){
      var uri = imageUrlReg.exec(val);
      if (uri){
        var imgurl = url.parse(uri[1], true);
        var params = imgurl.query;
        var id = params[&#x27;id&#x27;] || 0;
        ret = imgurl.pathname.replace(/\\+/g, &#x27;/&#x27;);
        //过滤图片
        if (!(PARAMS[&#x27;nosprite&#x27;] in params)){
          //设置第一个图片为sprite图片位置
          if (!this.get(&#x27;imgPath&#x27;)){
            this.set(&#x27;imgPath&#x27;, path.dirname(ret));
          }

          var preParam = this.get(&#x27;preParam&#x27;);
          var _id = this.get(&#x27;id&#x27;);
          if (_id == id){
            this.initSpriteConf(params);
            //依次初始化图片配置
            preParam.forEach(this.initSpriteConf, this);
            preParam = [];
          } else if (_id &lt; id){
            //如果id提前出现，既id为0的图片没有出现之前，id是1的已经出现了，把
            //当前参数存在数组preParam中
            var isNewImg = preParam.every(function(params){
              return params.id &lt; id;
            });
            if (isNewImg) preParam.push(params);
          }
          this.set(&#x27;preParam&#x27;, preParam);
        } else {
          var cssImgs = this.get(&#x27;cssImgs&#x27;);
          cssImgs.push(ret);
          rule.value[index] = val.replace(imgurl.pathname, ret);
          ret = false;
        }
      }
    }

    return ret;
  },

  /**
   * 文件读取完毕
   * @next Api.getImagesSize -&gt; this._setDef
   */
  _cssEnd: function(e){
    var images  = this.images;
    var baseDir = path.dirname(this.get(&#x27;file&#x27;));
    var files   = {};
    var equals = {};

    forEach(images, function(file, id){
      var fullPath = path.resolve(baseDir, file);
      if (files[fullPath] !== undefined) {
        equals[id] = files[fullPath];
      } else {
        //去除重复
        files[fullPath] = id;
      }
    });

    this.equals = equals;

    files = Object.keys(files);
    files.forEach(function(file){
      var fs = require(&#x27;fs&#x27;);
      var exists    = fs.existsSync;
      if (!exists(file)){
        Log.error(&#x27;图片&#x27; + path.relative(baseDir, file) + &#x27;不存在&#x27;);
      }
    });

    //获取图片大小
    Api.getImagesSize(files, this._setDef, this);
  },

  /**
   * 设置图片配置，Api.getImagesSize函数回调
   * @param {Error} err 错误信息
   * @param {string|json} data 读取图片大小接口返回数据，包括图片大小和图片类型
   * @next this._setPos
   */
  _setDef: function(err, data){

    if (err) throw Error(data.toString());

    var baseDir = path.dirname(this.get(&#x27;file&#x27;));
    var filePath;
    var imagesDef = this.imagesDef;

    forEach(data, function(def, file){
      filePath = path.relative(baseDir, file);
      filePath = filePath.replace(/\\+/g, &#x27;/&#x27;);
      imagesDef[filePath] = def;
    });

    this._setPos();
  },

  /**
   * 设置背景图位置
   */
  _setPos: function(){
    var imagesDef = this.imagesDef;
    //排序
    var imgs = Object.keys(imagesDef);

    var self = this;

    forEach(imgs, function(img){
      var imageInfo = imagesDef[img];
      var css = self._getCss(img);
      var box = new Box(css.property, css.value, css.line);
      imageInfo[&#x27;file_location&#x27;] = img;
      mixin(self._coords(box, imageInfo), imageInfo);

      self._setImageInfo(box, imageInfo);
    });

    //拼图算法接口调用
    forEach(this.sprites, function(sprite){
      var layout = sprite.layout;
      var file = layout;
      if (layout == &#x27;close&#x27; || layout == &#x27;auto&#x27;) file = &#x27;vertical&#x27;;
      var Locate = require(&#x27;../locating/&#x27; + file);
      var Loc = new Locate(sprite.images, imagesDef, layout || this.get(&#x27;layout&#x27;));
      sprite.height = Loc.height;
      sprite.width = Loc.width;
      this._setChangedRules(sprite);
      debugger;
    }, this);

    this.fire(&#x27;finish:parser&#x27;);
  },

  _setChangedRules: function(sprite){
    var imgBase      = sprite.relative || sprite.filename;
    var cssReader    = this.get(&#x27;cssReader&#x27;);
    var imgBase8     = imgBase.replace(&#x27;sprite.png&#x27;, &#x27;sprite8.png&#x27;);
    var imgPath      = sprite[&#x27;force8bit&#x27;] ? imgBase8 : imgBase;
    var changedRules = this.get(&#x27;changedRules&#x27;);
    var defs         = this.imagesDef;
    var extraRules   = this.get(&#x27;extraRules&#x27;);
    var spritesImgs  = this.get(&#x27;spritesImgs&#x27;);
    var cssImgs      = this.get(&#x27;cssImgs&#x27;);
    var selectors    = [];

    function setRule(def, rule, imgInfo){
      var value = [];
      var property = [];
      var filters = [&#x27;background&#x27;, &#x27;background-image&#x27;,
        &#x27;background-repeat&#x27;, &#x27;background-position&#x27;];

      property = rule.property.filter(function(prop, i){
        var index = filters.indexOf(prop);
        if (index === -1){
          value.push(rule.value[i]);
          return true;
        }
      });

      if (def[&#x27;repeat&#x27;] != &#x27;no-repeat&#x27;){
        property.push(&#x27;background-repeat&#x27;);
        value.push(def[&#x27;repeat&#x27;]);
      }

      property.push(&#x27;background-position&#x27;);
      value.push(def.position);

      changedRules[rule.id] = {
        selector: rule.selector,
        property: property,
        value: value,
        id: rule.id
      };
      selectors = selectors.concat(rule.selector);

    }

    var equals = this.equals;
    var eqInfos = {};
    forEach(equals, function(key1){
      eqInfos[key1] = &#x27;&#x27;;
    });

    forEach(sprite.images, function(imgInfo){
      var img = imgInfo[&#x27;file_location&#x27;];
      var rule = this._getCss(img);
      var def  = defs[img];
      if (eqInfos[rule.id] !== undefined) {
        eqInfos[rule.id] = [imgInfo, def];
      }
      setRule(def, rule, imgInfo);
    }, this);

    //规则重复的情况
    forEach(equals, function(id1, id2){
      var rule = cssReader.getRule(id2);
      var def = eqInfos[id1][1];
      var imgInfo = eqInfos[id1][0];

      //多规则提示，如果存在两个文件可能存在问题
      if (def) {
        Log.debug(&quot;file %s is repeat in css on line %s, this may case error&quot;, 
                    path.basename(imgInfo.file_location), rule.line);
        setRule(def, rule, imgInfo);
      }
    });

    var extraRule = {
      property: [&#x27;background-image&#x27;, &#x27;_background-image&#x27;, &#x27;background-repeat&#x27;],
      value: [&#x27;url(&#x27; + imgPath.replace(&#x27;sprite8&#x27;,&#x27;sprite&#x27;) + &#x27;)&#x27;, &#x27;url(&#x27; + imgPath + &#x27;)&#x27;, &#x27;no-repeat&#x27;,],
      selector: selectors
    };

    extraRules.push(extraRule);
    spritesImgs.push(imgBase);
    cssImgs.push(imgPath);
  },

  _setImageInfo: function(box, imageInfo){
    var id = this.get(&#x27;id&#x27;);
    var background = box.background;
    var params = background.params || {};
    var basename = this.get(&#x27;basename&#x27;);

    //sprite图片地址
    // &#x27;0&#x27; is true
    var spriteId = +params.id ? basename + params.id : basename;
    var sprites = this.sprites[spriteId];

    sprites[&#x27;images&#x27;][imageInfo[&#x27;file_location&#x27;]] = mixin(imageInfo, {});
    imageInfo.box = box;
  },

  /**
   * 生成sprite图片
   * @next writeCssBack 回写css样式，生成sprite样式
   */
  createSprite: function(){

    var sprites = this.sprites;

    if (Object.keys(sprites).length === 0) {
      Log.debug(&#x27;no image need merge&#x27;);
      this.fire(&#x27;finish:merge&#x27;, {exit: true});
    } else {
      //拼图
      Api.mergeImages([this.get(&#x27;file&#x27;), sprites], this._finishMerge, this);
    }
  },

  _finishMerge: function(err, data){

    if (err) throw new Error(data);

    Log.success(data.info);
    Log.debug();
    this.fire(&#x27;finish:merge&#x27;);

  },

  _coords: function(box, imageInfo){
    var ret = {
      &quot;repeat&quot;         : &#x27;no-repeat&#x27;,
      &quot;align&quot;          : &#x27;&#x27;,
      &quot;spritepos_left&quot; : 0,
      &quot;spritepos_top&quot;  : 0
    };
    var background = box.background;
    var repeat = background.repeat;
    var position = background.position;

    ret.repeat = repeat;
    if (position){
      //处理center
      if (position.x === &#x27;center&#x27;){
        if (box.width){
          position.x = Math.floor((box.width - imageInfo.width) / 2);
        } else {
          Log.error(&#x27;[Error info @&#x27; + box.line + 
            &#x27;]use 50% for background-position but not set &#x27;);
        }
      }

      if (position.y === &#x27;center&#x27;){
        if (box.width){
          position.y = Math.floor((box.height - imageInfo.height) / 2);
        } else {
          Log.error(&#x27;[Error info @&#x27; + box.line + 
            &#x27;]use 50% for background-position-y but not set height&#x27;);
        }
      }


      if (position.x == &#x27;right&#x27;) ret[&#x27;align&#x27;] = &#x27;right&#x27;;

      //is number
      if (+position.x) ret[&#x27;spritepos_left&#x27;] = parseInt(position.x, 10);
      if (+position.y) ret[&#x27;spritepos_top&#x27;] = parseInt(position.y, 10);


    }

    return ret;
  },
  /**
   * 获取图片对应的css规则，规定，同一个图片对应同一个规则，不允许同一个图片，
   * 使用不同的方式设置规则
   * @param img {string} img url
   * @return {object} css rules
   */
  _getCss: function(img){
    var cssReader = this.get(&#x27;cssReader&#x27;);
    var images    = this.images;
    var imgId     = null;

    some(images, function(imgPath, id){
      if (imgPath == img){
        imgId = id;
        return true;
      }
    });

    return cssReader.getRule(imgId);
  }

});

module.exports = SpriteDef;

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
